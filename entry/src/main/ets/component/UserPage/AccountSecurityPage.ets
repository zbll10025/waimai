import { ID } from "../../pages/LoginPage";
import { AxiosUtil } from "../../utils/network/HttpUtils";
import { promptAction } from '@kit.ArkUI';


interface GeneratedObjectLiteralInterface_1 {
  name: string;
  password: string;
}

interface GeneratedObjectLiteralInterface_2 {
  id: number;
  name: string;
  password: string;
  telePhone: string;
  balance: number;
}

@Component
export struct AccountSecurityPage {
  @StorageProp(ID) userid: string = '-1'
  @State username: string = ''
  @State telePhone : string = ''
  @State password: string = ''
  @State balance: number = -1
  @State isLoading: boolean = false
  @State errorMsg: string = ''
  @State isPasswordVisible: boolean = false
  @State isEditing: boolean = false
  @State editUsername: string = ''
  @State editPassword: string = ''
  @State isEditPasswordVisible: boolean = false
  @State isSaving: boolean = false

  private getFormattedBalance(): string {
    const b = this.balance as number
    if (typeof b === 'number' && !Number.isNaN(b) && b >= 0) {
      return `Â¥${b.toFixed(2)}`
    }
    return 'Â¥0.00'
  }

  aboutToAppear() {
    this.loadUserInfo();
  }

  build() {
    NavDestination() {
      Column() {
        // æ ‡é¢˜éƒ¨åˆ†
        Column() {
          Text('è´¦æˆ·ä¸å®‰å…¨')
            .fontSize(22)
            .fontWeight(600)
            .fontColor('#333333')

          Text('ç®¡ç†å¯†ç ã€æ‰‹æœºå·ç­‰å®‰å…¨è®¾ç½®')
            .fontSize(16)
            .fontColor('#666666')
            .margin({ top: 6 })
        }
        .width('100%')
        .padding({
          left: 16,
          right: 16,
          top: 16,
          bottom: 16
        })
        .backgroundColor('#FFFFFF')
        .borderRadius(12)

        // å†…è”ç¼–è¾‘åŒºåŸŸ
        if (this.isEditing) {
          Blank().height(12)

          Text('ç¼–è¾‘ä¿¡æ¯')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ left: 4, bottom: 8 })

          Column() {
            Row() {
              Text('ç”¨æˆ·å')
                .fontSize(15)
                .fontColor('#666666')
              Blank()
              TextInput({ placeholder: 'è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å', text: this.editUsername })
                .width('65%')
                .height(40)
                .backgroundColor('#F5F5F5')
                .borderRadius(8)
                .padding({ left: 12, right: 12 })
                .fontSize(15)
                .onChange((v: string) => { this.editUsername = v })
            }
            .width('100%')
            .margin({ bottom: 8 })

            Divider()
              .width('100%')
              .height(1)
              .backgroundColor('#EEEEEE')
              .margin({ bottom: 8 })

            Row() {
              Text('å¯†ç ')
                .fontSize(15)
                .fontColor('#666666')
              Blank()
              Row({ space: 8 }) {
                TextInput({ placeholder: 'è¯·è¾“å…¥æ–°çš„å¯†ç ', text: this.editPassword })
                  .width('55%')
                  .height(40)
                  .backgroundColor('#F5F5F5')
                  .borderRadius(8)
                  .padding({ left: 12, right: 12 })
                  .fontSize(15)
                  .type(this.isEditPasswordVisible ? InputType.Normal : InputType.Password)
                  .onChange((v: string) => { this.editPassword = v })
                // Button() {
                //   Text(this.isEditPasswordVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸')
                //     .fontSize(18)
                // }
                //   .onClick(() => { this.isEditPasswordVisible = !this.isEditPasswordVisible })
                //   .type(ButtonType.Normal)
                //   .backgroundColor('#F5F5F5')
                //   .fontColor('#333333')
              }
            }
            .width('100%')
            .margin({ bottom: 12 })

            Row({ space: 12 }) {
              Button('å–æ¶ˆ')
                .onClick(() => { this.isEditing = false })
                .type(ButtonType.Normal)
                .backgroundColor('#F5F5F5')
                .fontColor('#333333')

              Button(this.isSaving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜')
                .enabled(!this.isSaving && this.editUsername.trim().length > 0 && this.editPassword.trim().length > 0)
                .onClick(async () => { await this.saveUserInfo() })
                .type(ButtonType.Capsule)
                .backgroundColor('#FF6B35')
                .fontColor('#FFFFFF')
            }
          }
          .width('100%')
          .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
        }
        Blank().height(12)

        Text('åŸºæœ¬ä¿¡æ¯')
          .fontSize(14)
          .fontColor('#999999')
          .margin({ left: 4, bottom: 8 })

        // ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
        Column() {
          if (this.isLoading) {
            Text('æ­£åœ¨åŠ è½½...')
              .fontSize(14)
              .fontColor('#999999')
              .margin({ bottom: 12 })
          }

          if (this.errorMsg) {
            Text(this.errorMsg)
              .fontSize(14)
              .fontColor('#FF3B30')
              .margin({ bottom: 12 })
          }

          Row() {
            Text('å§“å')
              .fontSize(15)
              .fontColor('#666666')
            Blank()
            Text(this.username || '-')
              .fontSize(15)
              .fontColor('#333333')
          }
          .width('100%')
          .margin({ bottom: 8 })

          Divider()
            .width('100%')
            .height(1)
            .backgroundColor('#EEEEEE')
            .margin({ bottom: 8 })

          Row() {
            Text('ç”µè¯')
              .fontSize(15)
              .fontColor('#666666')
            Blank()
            Text(this.telePhone || '-')
              .fontSize(15)
              .fontColor('#333333')
          }
          .width('100%')
          .margin({ bottom: 8 })

          Divider()
            .width('100%')
            .height(1)
            .backgroundColor('#EEEEEE')
            .margin({ bottom: 8 })

          Row() {
            Text('å¯†ç ')
              .fontSize(15)
              .fontColor('#666666')
            Blank()
            Row({ space: 8 }) {
              Text(this.isPasswordVisible ? (this.password || '-') : 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢')
                .fontSize(15)
                .fontColor('#333333')
              Button() {
                Text(this.isPasswordVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸')
                  .fontSize(18)
              }
              .onClick(() => {
                this.isPasswordVisible = !this.isPasswordVisible
              })
              .type(ButtonType.Normal)
              .backgroundColor('#F5F5F5')
              .fontColor('#333333')
            }
          }
          .width('100%')
          .margin({ bottom: 8 })

          Divider()
            .width('100%')
            .height(1)
            .backgroundColor('#EEEEEE')
            .margin({ bottom: 8 })

          Row() {
            Text('ä½™é¢')
              .fontSize(15)
              .fontColor('#666666')
            Blank()
            Text(this.getFormattedBalance())
              .fontSize(15)
              .fontColor('#333333')
          }
          .width('100%')

          Blank().height(12)

          Row({ space: 12 }) {
            Button('åˆ·æ–°ä¿¡æ¯')
              .onClick(() => {
                this.loadUserInfo();
              })
              .type(ButtonType.Capsule)
              .backgroundColor('#FF6B35')
              .fontColor('#FFFFFF')

            // é¢„ç•™ï¼šä¿®æ”¹å¯†ç /ç»‘å®šæ‰‹æœºæ“ä½œå…¥å£
            Button('ä¿®æ”¹ä¸ªäººä¿¡æ¯')
              .onClick(() => {
                this.isEditing = true
                this.editUsername = this.username
                this.editPassword = this.password
                this.isEditPasswordVisible = false
              })
              .type(ButtonType.Normal)
              .backgroundColor('#F5F5F5')
              .fontColor('#333333')
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .backgroundColor('#FFFFFF')
        .borderRadius(12)
      }

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  private async loadUserInfo() {
    try {
      this.isLoading = true;
      this.errorMsg = '';
      const response = await AxiosUtil.get<User>(`http://192.168.213.120:8080/api/users/${this.userid}`);
      console.log("114514"+response.status)
      if (response.status === 200) {
        console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', response.data);
        this.username = response.data.name
        this.telePhone = response.data.telePhone
        this.password = response.data.password as string
        this.balance = response.data.balance as number

      } else {
        this.errorMsg = 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
        promptAction.showToast({ message: 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥' });
      }
    } catch (error) {
      console.error('ç”¨æˆ·ä¿¡æ¯åŠ è½½å¤±è´¥:', error);
      this.errorMsg = 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥';
      promptAction.showToast({ message: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥' });
    }
    finally {
      this.isLoading = false;
    }
  }

  private async saveUserInfo() {
    try {
      this.isSaving = true;
      const url = `http://192.168.213.120:8080/api/users/${this.userid}`;

      // æ„é€ å®Œæ•´çš„è¯·æ±‚ä½“ï¼ˆç¬¦åˆæ¥å£è¦æ±‚ï¼‰
      const payload: GeneratedObjectLiteralInterface_2 = {
        id: Number(this.userid), // å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—      // è·¯å¾„å‚æ•°ä¸­çš„idï¼ˆè½¬ä¸ºnumberï¼‰
        name: this.editUsername,  // å»é™¤ç©ºæ ¼ï¼Œé¿å…æ— æ•ˆè¾“å…¥
        password: this.editPassword, // å»é™¤ç©ºæ ¼
        telePhone: this.telePhone,       // ä¿ç•™å½“å‰æ‰‹æœºå·
        balance: this.balance            // ä¿ç•™å½“å‰ä½™é¢
      };

      // æ ¡éªŒå¿…å¡«å­—æ®µï¼ˆå¯é€‰ï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰
      if (!payload.name || !payload.password) {
        promptAction.showToast({ message: 'ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©º' });
        this.isSaving = false;
        return;
      }

      const response = await AxiosUtil.put<User>(url, payload);
      if (response.status === 200) {
        // æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä»…ä¿®æ”¹çš„å­—æ®µï¼‰
        this.username = payload.name;
        this.password = payload.password;
        promptAction.showToast({ message: 'ä¿®æ”¹æˆåŠŸ' });
        this.isEditing = false;
      } else {
        promptAction.showToast({ message: 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•' });
      }
    } catch (e) {
      console.error('æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
      promptAction.showToast({ message: 'ç½‘ç»œé”™è¯¯ï¼Œä¿®æ”¹å¤±è´¥' });
    } finally {
      this.isSaving = false;
    }
  }

}

class User {
  id?:number
  name: string = ''
  password: string = ''
  telePhone: string = ''
  balance?:number
}